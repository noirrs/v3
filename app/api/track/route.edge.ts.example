// ALTERNATIVE APPROACH: Edge Runtime with waitUntil
// Rename this file to route.ts if you want to use this approach
// Pros: Instant response (no latency), true fire-and-forget
// Cons: Edge runtime limitations, experimental waitUntil API

import { NextRequest, NextResponse } from "next/server";

export const runtime = "edge";

interface DemographicsData {
  timestamp: string;
  userAgent: string;
  language: string;
  timezone: string;
  country: string;
  city: string;
  latitude: number;
  longitude: number;
  screenWidth: number;
  screenHeight: number;
  deviceType: string;
  deviceName: string;
  referrer: string;
  isDarkMode: boolean;
  visitedDomain: string;
}

async function sendToTelegram(demographics: DemographicsData) {
  const botToken = process.env.TELEGRAM_BOT_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;

  if (!botToken || !chatId) {
    console.error("[Telegram] Missing credentials");
    return;
  }

  const deviceEmoji =
    demographics.deviceType === "mobile"
      ? "ğŸ“±"
      : demographics.deviceType === "tablet"
      ? "ğŸ“Š"
      : "ğŸ–¥ï¸";

  const themeEmoji = demographics.isDarkMode ? "ğŸŒ™" : "â˜€ï¸";
  const environmentEmoji =
    demographics.visitedDomain === "localhost" ? "ğŸ§ª" : "ğŸš€";

  const message = `${deviceEmoji} <b>New Visitor</b>

${environmentEmoji} <b>Environment:</b> ${
    demographics.visitedDomain === "localhost" ? "Development" : "Production"
  }
ğŸ“ <b>Domain:</b> ${demographics.visitedDomain}

ğŸ“ <b>Location:</b> ${demographics.city}, ${demographics.country}
   Coordinates: ${demographics.latitude.toFixed(
     2
   )}Â°, ${demographics.longitude.toFixed(2)}Â°

ğŸ“± <b>Device:</b> ${demographics.deviceName}
ğŸ“ <b>Screen Size:</b> ${demographics.screenWidth}x${demographics.screenHeight}

${themeEmoji} <b>Theme:</b> ${demographics.isDarkMode ? "Dark" : "Light"} Mode
ğŸŒ <b>Language:</b> ${demographics.language}
â° <b>Timezone:</b> ${demographics.timezone}

ğŸ”— <b>Referrer:</b> ${demographics.referrer || "Direct"}
âŒš <b>Timestamp:</b> ${new Date(demographics.timestamp).toLocaleString()}`;

  try {
    const response = await fetch(
      `https://api.telegram.org/bot${botToken}/sendMessage`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: "HTML",
        }),
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error("[Telegram] Send failed:", response.status, errorText);
    } else {
      console.log("[Telegram] Message sent successfully!");
    }
  } catch (error) {
    console.error("[Telegram] Error:", error);
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = (await request.json()) as DemographicsData;

    if (!body.timestamp || !body.userAgent) {
      return NextResponse.json(
        { error: "Missing required fields" },
        { status: 400 }
      );
    }

    const response = NextResponse.json(
      { success: true, message: "Demographics tracked" },
      { status: 200 }
    );

    // waitUntil allows background tasks to continue after response is sent
    // This is Edge runtime specific and may not be fully stable
    // @ts-expect-error - waitUntil might not be in types yet
    if (response.waitUntil) {
      // @ts-expect-error
      response.waitUntil(sendToTelegram(body));
    } else {
      // Fallback: await if waitUntil is not available
      console.warn("[Telegram] waitUntil not available, awaiting instead");
      await sendToTelegram(body);
    }

    return response;
  } catch (error) {
    console.error("API error:", error);
    return NextResponse.json(
      { success: true, message: "Request acknowledged" },
      { status: 200 }
    );
  }
}
